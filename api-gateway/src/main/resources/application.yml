# ===============================================
# ‚úÖ Í≥µÌÜµ ÏÑ§Ï†ï (Î™®Îì† ÌîÑÎ°úÌååÏùºÏóê Ï†ÅÏö©)
# ===============================================
server:
  port: 8000

jwt:
  secret: ${JWT_SECRET_KEY:}

management:
  endpoints:
    web:
      exposure:
        include: health,info
      base-path: /actuator
  endpoint:
    health:
      probes:
        enabled: true
      show-details: when-authorized

spring:
  application:
    name: api-gateway
  profiles:
    active: dev
  config:
    import: optional:file:application-dev.yml
  main:
    allow-bean-definition-overriding: true
    web-application-type: reactive
  webflux:
    base-path: /
  mvc:
    servlet:
      context-path: /
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration
      - org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration
      - org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
      - org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration
      - org.springframework.boot.autoconfigure.sql.init.SqlInitializationAutoConfiguration
      - org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration
  datasource:
    url: ""
    username: ""
    password: ""
    driver-class-name: ""
  data:
    redis:
      host: ${SPRING_DATA_REDIS_HOST:localhost}
      port: ${SPRING_DATA_REDIS_PORT:6379}
      password: ${SPRING_DATA_REDIS_PASSWORD:}
      timeout: 2000ms
      connect-timeout: 2000ms

logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: INFO
    org.springframework.cloud.kubernetes: INFO
    org.springframework.cloud.loadbalancer: INFO
    org.springframework.web.reactive: INFO
    reactor.netty: INFO
    com.example.api_gateway: INFO


---
# ===============================================
# üå≥ dev ÌîÑÎ°úÌååÏùº (Î°úÏª¨ Í∞úÎ∞ú ÌôòÍ≤Ω)
# ===============================================
spring:
  config:
    activate:
      on-profile: "dev"
  cloud:
    compatibility-verifier:
      enabled: false  # Spring Boot 3.5.6Í≥º Spring Cloud 2024.0.0 Ìò∏ÌôòÏÑ± Ï≤¥ÌÅ¨ ÎπÑÌôúÏÑ±Ìôî
    gateway:
      routes:
        # Ïù∏Ï¶ù ÏÑúÎπÑÏä§
        - id: auth-service
          uri: ${USER_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=1

        # ÏÇ¨Ïö©Ïûê ÏÑúÎπÑÏä§
        - id: user-service
          uri: ${USER_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=1

        # Í∑∏Î£π ÏÑúÎπÑÏä§
        - id: group-service
          uri: ${USER_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/groups/**
          filters:
            - StripPrefix=1

        # Ìà¨Ìëú ÏÑúÎπÑÏä§
        - id: vote-service
          uri: ${VOTE_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/vote/**,/api/votes/**
          filters:
            - StripPrefix=1

        # ÌûàÏä§ÌÜ†Î¶¨ ÏÑúÎπÑÏä§ (vote-serviceÏóêÏÑú Ï†úÍ≥µ)
        - id: history-service
          uri: ${VOTE_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/history/**
          filters:
            - StripPrefix=1

        # WebSocket ÏÑúÎπÑÏä§ (Ìä∏Î†àÏù¥Îî© ÏÑúÎπÑÏä§ ÎÇ¥Î∂Ä)
        - id: websocket-service
          uri: ${TRADING_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/websocket/**
          filters:
            - RewritePath=/api/websocket/(?<segment>.*), /${segment}

        # Ìä∏Î†àÏù¥Îî© ÏÑúÎπÑÏä§
        - id: trading-service
          uri: ${TRADING_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/trading/**,/api/group-trading/**
          filters:
            - StripPrefix=1

        # WebSocket Ïó∞Í≤∞ ÏóîÎìúÌè¨Ïù∏Ìä∏
        - id: websocket-connection
          uri: ws://${TRADING_SERVICE_URL:localhost:8081}
          predicates:
            - Path=/ws/**

        # ÏïåÎ¶º ÏÑúÎπÑÏä§ (vote-serviceÏóêÏÑú Ï†úÍ≥µ)
        - id: notification-service
          uri: ${VOTE_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/notification/**
          filters:
            - StripPrefix=1

        # Í≤∞Ï†ú ÏÑúÎπÑÏä§
        - id: pay-service
          uri: ${PAY_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/pay/**
          filters:
            - StripPrefix=1

        - id: payments-service
          uri: ${PAY_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/payments/**
          filters:
            - StripPrefix=1

        # QR ÏÑúÎπÑÏä§ (pay-serviceÏóêÏÑú Ï†úÍ≥µ)
        - id: qr-service
          uri: ${PAY_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/qr/**
          filters:
            - StripPrefix=1

        # Í≥ÑÏ¢å ÏÑúÎπÑÏä§ (pay-serviceÏóêÏÑú Ï†úÍ≥µ)
        - id: accounts-service
          uri: ${PAY_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/accounts/**
          filters:
            - StripPrefix=1

        # Swagger API Docs
        - id: user-service-api-docs
          uri: ${USER_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/v3/api-docs/user-service
          filters:
            - RewritePath=/v3/api-docs/user-service, /v3/api-docs

        - id: trading-service-api-docs
          uri: ${TRADING_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/v3/api-docs/trading-service
          filters:
            - RewritePath=/v3/api-docs/trading-service, /v3/api-docs

        - id: vote-service-api-docs
          uri: ${VOTE_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/v3/api-docs/vote-service
          filters:
            - RewritePath=/v3/api-docs/vote-service, /v3/api-docs

        - id: pay-service-api-docs
          uri: ${PAY_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/v3/api-docs/pay-service
          filters:
            - RewritePath=/v3/api-docs/pay-service, /v3/api-docs
    kubernetes:
      discovery:
        enabled: false  # Î°úÏª¨ Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÏÑúÎäî ÎπÑÌôúÏÑ±Ìôî
        all-namespaces: false
      reload:
        enabled: false
      config:
        enabled: false
    loadbalancer:
      enabled: false  # Î°úÏª¨ Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÏÑúÎäî ÎπÑÌôúÏÑ±Ìôî
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration
      - org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration
      - org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
      - org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration
      - org.springframework.boot.autoconfigure.sql.init.SqlInitializationAutoConfiguration
      - org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration
      - org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration
      - org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration

springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    urls:
      - name: user-service
        url: /v3/api-docs/user-service
      - name: trading-service
        url: /v3/api-docs/trading-service
      - name: vote-service
        url: /v3/api-docs/vote-service
      - name: pay-service
        url: /v3/api-docs/pay-service
    groups-order: DESC

---
# ===============================================
# üöÄ main ÌîÑÎ°úÌååÏùº (AWS EKS Ïö¥ÏòÅ ÌôòÍ≤Ω)
# ===============================================
spring:
  config:
    activate:
      on-profile: "main"
  cloud:
    gateway:
      routes: #deprecatedÏ†ÑÏóê server: webflux: routes: ÌòïÌÉúÎ°ú ÏàòÏ†ïÌï¥ÏïºÌï®.
        # ===============================================
        # üöÄ ÌòÑÏû¨ ÏÑ§Ï†ï (ÌôòÍ≤ΩÎ≥ÄÏàò Î∞©Ïãù) - Í∂åÏû•
        # ===============================================
        - id: auth-service-route
          uri: ${USER_SERVICE_URL:http://user-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=1
        - id: user-service-route
          uri: ${USER_SERVICE_URL:http://user-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=1
        - id: group-service-route
          uri: ${USER_SERVICE_URL:http://user-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/groups/**
          filters:
            - StripPrefix=1
        - id: vote-service-route
          uri: ${VOTE_SERVICE_URL:http://vote-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/vote/**,/api/votes/**
          filters:
            - StripPrefix=1
        - id: history-service-route
          uri: ${VOTE_SERVICE_URL:http://vote-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/history/**
          filters:
            - StripPrefix=1
        - id: notification-service-route
          uri: ${VOTE_SERVICE_URL:http://vote-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/notification/**
          filters:
            - StripPrefix=1
        - id: websocket-service-route
          uri: ${TRADING_SERVICE_URL:http://trading-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/websocket/**
          filters:
            - RewritePath=/api/websocket/(?<segment>.*), /${segment}
        - id: trading-service-route
          uri: ${TRADING_SERVICE_URL:http://trading-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/trading/**
          filters:
            - StripPrefix=1
        - id: websocket-connection-route
          uri: http://${TRADING_SERVICE_URL:trading-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/ws/**
        - id: vote-trading-service-route
          uri: ${TRADING_SERVICE_URL:http://trading-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/vote-trading/**
          filters:
            - StripPrefix=1
        - id: group-trading-service-route
          uri: ${TRADING_SERVICE_URL:http://trading-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/group-trading/**
          filters:
            - StripPrefix=1
        - id: batch-service-route
          uri: ${TRADING_SERVICE_URL:http://trading-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/batch/**
          filters:
            - StripPrefix=1
        - id: admin-kis-service-route
          uri: ${TRADING_SERVICE_URL:http://trading-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/admin/kis/**
          filters:
            - StripPrefix=1
        - id: pay-service-route
          uri: ${PAY_SERVICE_URL:http://pay-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/pay/**
          filters:
            - StripPrefix=1
        - id: payments-service-route
          uri: ${PAY_SERVICE_URL:http://pay-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/payments/**
          filters:
            - StripPrefix=1
        - id: accounts-service-route
          uri: ${PAY_SERVICE_URL:http://pay-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/accounts/**
          filters:
            - StripPrefix=1
        - id: qr-service-route
          uri: ${PAY_SERVICE_URL:http://pay-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/qr/**
          filters:
            - StripPrefix=1
        - id: transfers-service-route
          uri: ${PAY_SERVICE_URL:http://pay-service.togather.svc.cluster.local:8080}
          predicates:
            - Path=/api/transfers/**
          filters:
            - StripPrefix=1

        # ===============================================
        # üîÑ Î°§Î∞±Ïö© Í∏∞Ï°¥ ÏÑ§Ï†ï (lb:// Î∞©Ïãù) - Ï£ºÏÑùÏ≤òÎ¶¨Îê®
        # ===============================================
        # Í∏∞Ï°¥Ïóê Ïûò ÏûëÎèôÌñàÎçò lb:// Î∞©Ïãù (Î¨∏Ï†ú Î∞úÏÉù Ïãú Ï£ºÏÑù Ìï¥Ï†úÌïòÏó¨ Î°§Î∞± Í∞ÄÎä•)
        # - id: auth-service-route
        #   uri: lb://user-service
        #   predicates:
        #     - Path=/api/auth/**
        #   filters:
        #     - StripPrefix=1
        # - id: user-service-route
        #   uri: lb://user-service
        #   predicates:
        #     - Path=/api/users/**
        #   filters:
        #     - StripPrefix=1
        # - id: group-service-route
        #   uri: lb://user-service
        #   predicates:
        #     - Path=/api/groups/**
        #   filters:
        #     - StripPrefix=1
        # - id: vote-service-route
        #   uri: lb://vote-service
        #   predicates:
        #     - Path=/api/vote/**,/api/votes/**
        #   filters:
        #     - StripPrefix=1
        # - id: history-service-route
        #   uri: lb://vote-service
        #   predicates:
        #     - Path=/api/history/**
        #   filters:
        #     - StripPrefix=1
        # - id: notification-service-route
        #   uri: lb://vote-service
        #   predicates:
        #     - Path=/api/notification/**
        #   filters:
        #     - StripPrefix=1
        # - id: websocket-service-route
        #   uri: lb://trading-service
        #   predicates:
        #     - Path=/api/websocket/**
        #   filters:
        #     - RewritePath=/api/websocket/(?<segment>.*), /${segment}
        # - id: trading-service-route
        #   uri: lb://trading-service
        #   predicates:
        #     - Path=/api/trading/**
        #   filters:
        #     - StripPrefix=1
        # - id: websocket-connection-route
        #   uri: lb://trading-service
        #   predicates:
        #     - Path=/ws/**
        # - id: vote-trading-service-route
        #   uri: lb://trading-service
        #   predicates:
        #     - Path=/api/vote-trading/**
        #   filters:
        #     - StripPrefix=1
        # - id: group-trading-service-route
        #   uri: lb://trading-service
        #   predicates:
        #     - Path=/api/group-trading/**
        #   filters:
        #     - StripPrefix=1
        # - id: batch-service-route
        #   uri: lb://trading-service
        #   predicates:
        #     - Path=/api/batch/**
        #   filters:
        #     - StripPrefix=1
        # - id: admin-kis-service-route
        #   uri: lb://trading-service
        #   predicates:
        #     - Path=/api/admin/kis/**
        #   filters:
        #     - StripPrefix=1
        # - id: pay-service-route
        #   uri: lb://pay-service
        #   predicates:
        #     - Path=/api/pay/**
        #   filters:
        #     - StripPrefix=1
        # - id: payments-service-route
        #   uri: lb://pay-service
        #   predicates:
        #     - Path=/api/payments/**
        #   filters:
        #     - StripPrefix=1
        # - id: accounts-service-route
        #   uri: lb://pay-service
        #   predicates:
        #     - Path=/api/accounts/**
        #   filters:
        #     - StripPrefix=1
        # - id: qr-service-route
        #   uri: lb://pay-service
        #   predicates:
        #     - Path=/api/qr/**
        #   filters:
        #     - StripPrefix=1
        # - id: transfers-service-route
        #   uri: lb://pay-service
        #   predicates:
        #     - Path=/api/transfers/**
        #   filters:
        #     - StripPrefix=1
    kubernetes:
      discovery:
        enabled: true
        all-namespaces: false
      reload:
        enabled: false
      config:
        enabled: false
    loadbalancer:
      enabled: true
      health-check:
        initial-delay: 0
        interval: 1s
    compatibility-verifier:
      enabled: false
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration
      - org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration
  logging:
    level:
      org.springframework.web.reactive.function.client.ExchangeFunctions: DEBUG
      reactor.netty.http.client: DEBUG
