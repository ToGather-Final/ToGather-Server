# ===============================================
# âœ… ê³µí†µ ì„¤ì • (ëª¨ë“  í”„ë¡œíŒŒì¼ì— ì ìš©)
# ===============================================
server:
  port: 8000

jwt:
  secret: ${JWT_SECRET_KEY:}

management:
  endpoints:
    web:
      exposure:
        include: health,info
      base-path: /actuator
  endpoint:
    health:
      probes:
        enabled: true
      show-details: when-authorized

spring:
  application:
    name: api-gateway
  profiles:
    active: dev
  config:
    import: optional:file:application-dev.yml
  main:
    allow-bean-definition-overriding: true
    web-application-type: reactive
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration
      - org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration
      - org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
      - org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration
      - org.springframework.boot.autoconfigure.sql.init.SqlInitializationAutoConfiguration
      - org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration
  datasource:
    url: ""
    username: ""
    password: ""
    driver-class-name: ""
  data:
    redis:
      host: ${SPRING_DATA_REDIS_HOST:localhost}
      port: ${SPRING_DATA_REDIS_PORT:6379}
      password: ${SPRING_DATA_REDIS_PASSWORD:}
      timeout: 2000ms
      connect-timeout: 2000ms

logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: INFO
    org.springframework.cloud.kubernetes: INFO
    org.springframework.cloud.loadbalancer: INFO
    org.springframework.web.reactive: INFO
    reactor.netty: INFO
    com.example.api_gateway: INFO

---
# ===============================================
# ğŸŒ³ dev í”„ë¡œíŒŒì¼ (ë¡œì»¬ ê°œë°œ í™˜ê²½)
# ===============================================
spring:
  config:
    activate:
      on-profile: "dev"
  cloud:
    compatibility-verifier:
      enabled: false  # Spring Boot 3.5.6ê³¼ Spring Cloud 2024.0.0 í˜¸í™˜ì„± ì²´í¬ ë¹„í™œì„±í™”
    gateway:
      routes:
        # ì¸ì¦ ì„œë¹„ìŠ¤
        - id: auth-service
          uri: http://localhost:8082
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=1

        # ì‚¬ìš©ì ì„œë¹„ìŠ¤
        - id: user-service
          uri: http://localhost:8082
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=1

        # ê·¸ë£¹ ì„œë¹„ìŠ¤
        - id: group-service
          uri: http://localhost:8082
          predicates:
            - Path=/api/groups/**
          filters:
            - StripPrefix=1

        # íˆ¬í‘œ ì„œë¹„ìŠ¤
        - id: vote-service
          uri: http://localhost:8084
          predicates:
            - Path=/api/vote/**,/api/votes/**
          filters:
            - StripPrefix=1

        # íˆìŠ¤í† ë¦¬ ì„œë¹„ìŠ¤ (vote-serviceì—ì„œ ì œê³µ)
        - id: history-service
          uri: http://localhost:8084
          predicates:
            - Path=/api/history/**
          filters:
            - StripPrefix=1

        # WebSocket ì„œë¹„ìŠ¤ (íŠ¸ë ˆì´ë”© ì„œë¹„ìŠ¤ ë‚´ë¶€)
        - id: websocket-service
          uri: http://localhost:8081
          predicates:
            - Path=/api/websocket/**
          filters:
            - RewritePath=/api/websocket/(?<segment>.*), /${segment}

            
        # íŠ¸ë ˆì´ë”© ì„œë¹„ìŠ¤
        - id: trading-service
          uri: http://localhost:8081
          predicates:
            - Path=/api/trading/**
          filters:
            - StripPrefix=1

        # WebSocket ì—°ê²° ì—”ë“œí¬ì¸íŠ¸
        - id: websocket-connection
          uri: http://localhost:8081
          predicates:
            - Path=/ws/**

        # ê²°ì œ ì„œë¹„ìŠ¤
        - id: pay-service
          uri: http://localhost:8083
          predicates:
            - Path=/api/pay/**
          filters:
            - StripPrefix=1

        # ê³„ì¢Œ ì„œë¹„ìŠ¤ (pay-serviceì—ì„œ ì œê³µ)
        - id: accounts-service
          uri: http://localhost:8083
          predicates:
            - Path=/api/accounts/**
          filters:
            - StripPrefix=1
    kubernetes:
      discovery:
        enabled: false  # ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë¹„í™œì„±í™”
        all-namespaces: false
      reload:
        enabled: false
      config:
        enabled: false
    loadbalancer:
      enabled: false  # ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë¹„í™œì„±í™”
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration
      - org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration
      - org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
      - org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration
      - org.springframework.boot.autoconfigure.sql.init.SqlInitializationAutoConfiguration
      - org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration
      - org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration
      - org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration

---
# ===============================================
# ğŸš€ main í”„ë¡œíŒŒì¼ (AWS EKS ìš´ì˜ í™˜ê²½)
# ===============================================
spring:
  config:
    activate:
      on-profile: "main"
  cloud:
    gateway:
      routes: #deprecatedì „ì— server: webflux: routes: í˜•íƒœë¡œ ìˆ˜ì •í•´ì•¼í•¨.
        - id: auth-service-route
          uri: lb://user-service
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=1
        - id: user-service-route
          uri: lb://user-service
          predicates:
            - Path=/api/user/**
          filters:
            - StripPrefix=1
        - id: vote-service-route
          uri: lb://vote-service
          predicates:
            - Path=/api/vote/**,/api/votes/**
          filters:
            - StripPrefix=1
        - id: history-service-route
          uri: lb://vote-service
          predicates:
            - Path=/api/history/**
          filters:
            - StripPrefix=1
        - id: notification-service-route
          uri: lb://vote-service
          predicates:
            - Path=/api/notification/**
          filters:
            - StripPrefix=1
        - id: websocket-service-route
          uri: lb://trading-service
          predicates:
            - Path=/api/websocket/**
          filters:
            - RewritePath=/api/websocket/(?<segment>.*), /${segment}
        - id: trading-service-route
          uri: lb://trading-service
          predicates:
            - Path=/api/trading/**
          filters:
            - StripPrefix=1
        - id: websocket-connection-route
          uri: lb://trading-service
          predicates:
            - Path=/ws/**
        - id: pay-service-route
          uri: lb://pay-service
          predicates:
            - Path=/api/pay/**
          filters:
            - StripPrefix=1
        - id: accounts-service-route
          uri: lb://pay-service
          predicates:
            - Path=/api/accounts/**
          filters:
            - StripPrefix=1
    kubernetes:
      discovery:
        enabled: true
        all-namespaces: false
      reload:
        enabled: false
      config:
        enabled: false
    loadbalancer:
      enabled: true
      health-check:
        initial-delay: 0
        interval: 1s
    compatibility-verifier:
      enabled: false