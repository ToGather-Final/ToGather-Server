apiVersion: apps/v1
kind: Deployment
metadata:
  name: nextjs-client
  namespace: togather
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nextjs-client
  template:
    metadata:
      labels:
        app: nextjs-client
    spec:
      containers:
        - name: nextjs-client
          image: ${ECR_REGISTRY}/togather/client:latest
          ports:
            - containerPort: 3000
          resources:
            # t3.large 노드에 최적화된 리소스 할당 (CPU 부족 문제 해결)
            # 전체 8GB 중 Next.js에 1GB 할당 (12.5%)
            requests:
              memory: "256Mi"    # 최소 메모리 (부팅 시)
              cpu: "100m"        # 최소 CPU (0.1 core) - CPU 부족 해결
            limits:
              memory: "1Gi"      # 최대 메모리 (1GB)
              cpu: "500m"        # 최대 CPU (0.5 core) - CPU 부족 해결
          env:
            - name: NODE_ENV
              value: "production"
            - name: NEXT_TELEMETRY_DISABLED
              value: "1"
            # Node.js 성능 최적화 (메모리 증가)
            - name: NODE_OPTIONS
              value: "--max-old-space-size=896 --max-semi-space-size=128"
            # Next.js 성능 최적화
            - name: NEXT_PUBLIC_ANALYTICS_ID
              value: ""
            - name: NEXT_PUBLIC_VERCEL_ANALYTICS_ID
              value: ""
            - name: NODE_NO_WARNINGS
              value: "1"
          # t3.large 노드에 최적화된 Health Check (CPU 부하 최소화)
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 120   # 충분한 부팅 시간
            periodSeconds: 60          # CPU 부하 최소화
            timeoutSeconds: 15         # 네트워크 지연 고려
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 60    # 충분한 초기 부팅 시간
            periodSeconds: 30          # CPU 부하 감소
            timeoutSeconds: 10         # 네트워크 지연 고려
            failureThreshold: 3
          # t3.large 노드에 최적화된 시작 설정
          startupProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 18       # 최대 3분 대기 (충분한 시간)
---
apiVersion: v1
kind: Service
metadata:
  name: nextjs-client
  namespace: togather
spec:
  selector:
    app: nextjs-client
  ports:
    - port: 3000
      targetPort: 3000
  type: ClusterIP