apiVersion: apps/v1
kind: Deployment
metadata:
  name: nextjs-client
  namespace: togather
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nextjs-client
  template:
    metadata:
      labels:
        app: nextjs-client
    spec:
      containers:
        - name: nextjs-client
          image: ${ECR_REGISTRY}/togather/client:latest
          ports:
            - containerPort: 3000
          resources:
            # t3.large 노드에 최적화된 리소스 할당
            # 전체 8GB 중 Next.js에 1GB 할당 (12.5%)
            requests:
              memory: "512Mi"    # 최소 메모리 (부팅 시)
              cpu: "200m"        # 최소 CPU (0.2 core)
            limits:
              memory: "1Gi"      # 최대 메모리 (1GB)
              cpu: "800m"        # 최대 CPU (0.8 core)
          env:
            - name: NODE_ENV
              value: "production"
            - name: NEXT_TELEMETRY_DISABLED
              value: "1"
            # Node.js 성능 최적화
            - name: NODE_OPTIONS
              value: "--max-old-space-size=768 --optimize-for-size"
            # Next.js 성능 최적화
            - name: NEXT_PUBLIC_ANALYTICS_ID
              value: ""
            - name: NEXT_PUBLIC_VERCEL_ANALYTICS_ID
              value: ""
            # 메모리 사용량 최적화
            - name: NODE_ENV
              value: "production"
            - name: NODE_NO_WARNINGS
              value: "1"
          # t3.large 노드에 최적화된 Health Check
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 60    # Node.js 부팅 시간 고려
            periodSeconds: 30          # CPU 부하 감소
            timeoutSeconds: 10         # 네트워크 지연 고려
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 30    # 초기 부팅 시간
            periodSeconds: 10          # 적당한 빈도
            timeoutSeconds: 5          # 빠른 실패 감지
            failureThreshold: 3
          # t3.large 노드에 최적화된 시작 설정
          startupProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 12       # 최대 60초 대기
---
apiVersion: v1
kind: Service
metadata:
  name: nextjs-client
  namespace: togather
spec:
  selector:
    app: nextjs-client
  ports:
    - port: 3000
      targetPort: 3000
  type: ClusterIP