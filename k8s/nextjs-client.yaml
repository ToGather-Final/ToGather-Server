apiVersion: apps/v1
kind: Deployment
metadata:
  name: nextjs-client
  namespace: togather
spec:
  replicas: 1  # ğŸš€ ë‹¨ì¼ Pod ê³ ì • (Cold Start ì™„ì „ ì œê±°)
  strategy:
    type: Recreate       # ğŸš€ ë‹¨ì¼ Podì´ë¯€ë¡œ Recreate ì‚¬ìš©
  selector:
    matchLabels:
      app: nextjs-client
  template:
    metadata:
      labels:
        app: nextjs-client
    spec:
      # ğŸš€ ë‹¨ì¼ Podì´ë¯€ë¡œ Anti-Affinity ì„¤ì • ì œê±°
      containers:
        - name: nextjs-client
          image: ${ECR_REGISTRY}/togather/client:latest
          ports:
            - containerPort: 3000
          resources:
              # ğŸš€ t3.large ë‘ ê°œì— ìµœì í™”ëœ ë¦¬ì†ŒìŠ¤ ì„¤ì •
              requests:
                memory: "2Gi"      # ë©”ëª¨ë¦¬ ìš”ì²­ 2GB (t3.largeì— ì í•©)
                cpu: "1000m"       # CPU ìš”ì²­ 1 vCPU (ì•ˆì •ì )
              limits:
                memory: "4Gi"      # ë©”ëª¨ë¦¬ ì œí•œ 4GB (ì¶©ë¶„í•œ ì—¬ìœ )
                cpu: "2000m"       # CPU ì œí•œ 2 vCPU (ê³ ì„±ëŠ¥)
          env:
            - name: NODE_ENV
              value: "production"
            - name: NEXT_TELEMETRY_DISABLED
              value: "1"
            # ğŸš€ Node.js ìµœì í™” (t3.largeì— ë§ì¶¤)
            - name: NODE_OPTIONS
              value: "--max-old-space-size=3584 --max-semi-space-size=512 --optimize-for-size --gc-interval=100"
            # Next.js ì„±ëŠ¥ ìµœì í™”
            - name: NEXT_PUBLIC_ANALYTICS_ID
              value: ""
            - name: NEXT_PUBLIC_VERCEL_ANALYTICS_ID
              value: ""
            - name: NODE_NO_WARNINGS
              value: "1"
            # ğŸ” ë¡œê¹… ë° ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì„¤ì •
            - name: DEBUG
              value: "next:*"
            - name: NEXT_DEBUG
              value: "1"
            - name: NEXT_LOG_LEVEL
              value: "debug"
            - name: NODE_DEBUG
              value: "http,net,tls"
            # ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
            - name: NEXT_PRIVATE_DEBUG_CACHE
              value: "1"
            - name: NEXT_PRIVATE_DEBUG_MEMORY
              value: "1"
            # ğŸš€ Cold Start ë°©ì§€ ì„¤ì •
            - name: NEXT_PRIVATE_DEBUG_CACHE_MISSES
              value: "0"
            - name: NEXT_PRIVATE_DEBUG_CACHE_HITS
              value: "0"
            # Next.js ì„±ëŠ¥ ìµœì í™”
            - name: NEXT_PRIVATE_DEBUG_SWC
              value: "0"
            - name: NEXT_PRIVATE_DEBUG_SWC_CACHE
              value: "0"
            # ë©”ëª¨ë¦¬ ìµœì í™” (ì¤‘ë³µ ì œê±°)
          # ğŸš€ ë‹¨ì¼ Pod Health Check ìµœì í™”
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 10  # ğŸš€ ë‹¨ì¼ Podì´ë¯€ë¡œ ë¹ ë¥¸ ì‹œì‘
            periodSeconds: 30        # ğŸš€ ì²´í¬ ì£¼ê¸° ì¦ê°€ (ì•ˆì •ì )
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 2   # ğŸš€ ë§¤ìš° ë¹ ë¥¸ ì‹œì‘
            periodSeconds: 5         # ğŸš€ ì²´í¬ ì£¼ê¸°
            timeoutSeconds: 3
            failureThreshold: 2
          # startupProbe ì œê±° (ë‹¨ì¼ Podì´ë¯€ë¡œ ë¶ˆí•„ìš”)
---
apiVersion: v1
kind: Service
metadata:
  name: nextjs-client
  namespace: togather
spec:
  selector:
    app: nextjs-client
  ports:
    - port: 3000
      targetPort: 3000
  type: ClusterIP