apiVersion: apps/v1
kind: Deployment
metadata:
  name: nextjs-client
  namespace: togather
spec:
  replicas: 1  # 🚀 단일 Pod 고정 (Cold Start 완전 제거)
  strategy:
    type: Recreate       # 🚀 단일 Pod이므로 Recreate 사용
  selector:
    matchLabels:
      app: nextjs-client
  template:
    metadata:
      labels:
        app: nextjs-client
    spec:
      # 🚀 단일 Pod이므로 Anti-Affinity 설정 제거
      containers:
        - name: nextjs-client
          image: ${ECR_REGISTRY}/togather/client:latest
          ports:
            - containerPort: 3000
          resources:
              # 🚀 t3.large 두 개에 최적화된 리소스 설정
              requests:
                memory: "2Gi"      # 메모리 요청 2GB (t3.large에 적합)
                cpu: "1000m"       # CPU 요청 1 vCPU (안정적)
              limits:
                memory: "4Gi"      # 메모리 제한 4GB (충분한 여유)
                cpu: "2000m"       # CPU 제한 2 vCPU (고성능)
          env:
            - name: NODE_ENV
              value: "production"
            - name: NEXT_TELEMETRY_DISABLED
              value: "1"
            # 🚀 Node.js 최적화 (t3.large에 맞춤)
            - name: NODE_OPTIONS
              value: "--max-old-space-size=3584 --max-semi-space-size=512 --optimize-for-size --gc-interval=100"
            # Next.js 성능 최적화
            - name: NEXT_PUBLIC_ANALYTICS_ID
              value: ""
            - name: NEXT_PUBLIC_VERCEL_ANALYTICS_ID
              value: ""
            - name: NODE_NO_WARNINGS
              value: "1"
            # 🔍 로깅 및 성능 모니터링 설정
            - name: DEBUG
              value: "next:*"
            - name: NEXT_DEBUG
              value: "1"
            - name: NEXT_LOG_LEVEL
              value: "debug"
            - name: NODE_DEBUG
              value: "http,net,tls"
            # 성능 모니터링
            - name: NEXT_PRIVATE_DEBUG_CACHE
              value: "1"
            - name: NEXT_PRIVATE_DEBUG_MEMORY
              value: "1"
            # 🚀 Cold Start 방지 설정
            - name: NEXT_PRIVATE_DEBUG_CACHE_MISSES
              value: "0"
            - name: NEXT_PRIVATE_DEBUG_CACHE_HITS
              value: "0"
            # Next.js 성능 최적화
            - name: NEXT_PRIVATE_DEBUG_SWC
              value: "0"
            - name: NEXT_PRIVATE_DEBUG_SWC_CACHE
              value: "0"
            # 메모리 최적화 (중복 제거)
          # 🚀 단일 Pod Health Check 최적화
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 10  # 🚀 단일 Pod이므로 빠른 시작
            periodSeconds: 30        # 🚀 체크 주기 증가 (안정적)
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 2   # 🚀 매우 빠른 시작
            periodSeconds: 5         # 🚀 체크 주기
            timeoutSeconds: 3
            failureThreshold: 2
          # startupProbe 제거 (단일 Pod이므로 불필요)
---
apiVersion: v1
kind: Service
metadata:
  name: nextjs-client
  namespace: togather
spec:
  selector:
    app: nextjs-client
  ports:
    - port: 3000
      targetPort: 3000
  type: ClusterIP