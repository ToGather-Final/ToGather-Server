apiVersion: apps/v1
kind: Deployment
metadata:
  name: nextjs-client
  namespace: togather
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nextjs-client
  template:
    metadata:
      labels:
        app: nextjs-client
    spec:
      containers:
        - name: nextjs-client
          image: ${ECR_REGISTRY}/togather/client:latest
          ports:
            - containerPort: 3000
          resources:
            # t3.large 노드에 최적화된 리소스 할당 (콜드 스타트 개선)
            # 전체 8GB 중 Next.js에 1GB 할당 (12.5%)
            requests:
              memory: "512Mi"    # 빠른 부팅을 위한 메모리 증가
              cpu: "200m"        # 빠른 부팅을 위한 CPU 증가
            limits:
              memory: "1Gi"      # 최대 메모리 (1GB)
              cpu: "800m"        # 최대 CPU (0.8 core) - 부팅 시 더 많은 CPU
          env:
            - name: NODE_ENV
              value: "production"
            - name: NEXT_TELEMETRY_DISABLED
              value: "1"
            # Node.js 성능 최적화 (메모리 증가)
            - name: NODE_OPTIONS
              value: "--max-old-space-size=896 --max-semi-space-size=128"
            # Next.js 성능 최적화
            - name: NEXT_PUBLIC_ANALYTICS_ID
              value: ""
            - name: NEXT_PUBLIC_VERCEL_ANALYTICS_ID
              value: ""
            - name: NODE_NO_WARNINGS
              value: "1"
          # t3.large 노드에 최적화된 Health Check (콜드 스타트 개선)
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 60    # 부팅 시간 단축
            periodSeconds: 30          # CPU 부하 최소화
            timeoutSeconds: 10         # 네트워크 지연 고려
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 30    # 빠른 준비 상태 감지
            periodSeconds: 10          # 자주 체크
            timeoutSeconds: 5          # 빠른 응답
            failureThreshold: 3
          # t3.large 노드에 최적화된 시작 설정 (콜드 스타트 개선)
          startupProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 10    # 빠른 시작
            periodSeconds: 5           # 자주 체크
            timeoutSeconds: 3          # 빠른 응답
            failureThreshold: 24       # 최대 2분 대기
---
apiVersion: v1
kind: Service
metadata:
  name: nextjs-client
  namespace: togather
spec:
  selector:
    app: nextjs-client
  ports:
    - port: 3000
      targetPort: 3000
  type: ClusterIP