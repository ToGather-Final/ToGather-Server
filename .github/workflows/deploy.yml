name: Deploy ToGather Microservices to AWS EKS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com
  EKS_CLUSTER_NAME: togather-cluster
  EKS_NAMESPACE: togather

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set gradlew permissions
      run: chmod +x gradlew

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push Nginx image
      run: |
        docker build -t $ECR_REGISTRY/togather/nginx:${{ github.sha }} -f ./nginx/Dockerfile .
        docker build -t $ECR_REGISTRY/togather/nginx:latest -f ./nginx/Dockerfile .
        docker push $ECR_REGISTRY/togather/nginx:${{ github.sha }}
        docker push $ECR_REGISTRY/togather/nginx:latest

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Build with Gradle
      run: |
        chmod +x gradlew
        ./gradlew build -x test

    - name: Checkout Client Repo ## ğŸ‘ˆ ì¶”ê°€ëœ ë¶€ë¶„
      uses: actions/checkout@v4
      with:
        repository: ToGather-Final/ToGather-Client # ë³¸ì¸ Client ë¦¬í¬ì§€í† ë¦¬
        token: ${{ secrets.GH_PAT }}
        path: togather-client # 'togather-client' í´ë”ì— í´ë¡ 

    - name: Setup Node.js ## ğŸ‘ˆ ì¶”ê°€ëœ ë¶€ë¶„
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build Client ## ğŸ‘ˆ ì¶”ê°€ëœ ë¶€ë¶„
      run: |
        cd togather-client
        npm install
        npm run build

    - name: Build and push Nginx image ## ğŸ‘ˆ ì¶”ê°€ëœ ë¶€ë¶„
      run: |
        docker build -f nginx/Dockerfile -t $ECR_REGISTRY/togather/nginx:${{ github.sha }} .
        docker build -f nginx/Dockerfile -t $ECR_REGISTRY/togather/nginx:latest .
        docker push $ECR_REGISTRY/togather/nginx:${{ github.sha }}
        docker push $ECR_REGISTRY/togather/nginx:latest

    - name: Build and push API Gateway image
      run: |
        docker build -f api-gateway/Dockerfile -t $ECR_REGISTRY/togather/api-gateway:${{ github.sha }} .
        docker build -f api-gateway/Dockerfile -t $ECR_REGISTRY/togather/api-gateway:latest .
        docker push $ECR_REGISTRY/togather/api-gateway:${{ github.sha }}
        docker push $ECR_REGISTRY/togather/api-gateway:latest

    - name: Build and push User Service image
      run: |
        docker build -f user-service/Dockerfile -t $ECR_REGISTRY/togather/user-service:${{ github.sha }} .
        docker build -f user-service/Dockerfile -t $ECR_REGISTRY/togather/user-service:latest .
        docker push $ECR_REGISTRY/togather/user-service:${{ github.sha }}
        docker push $ECR_REGISTRY/togather/user-service:latest

    - name: Build and push Trading Service image
      run: |
        docker build -f trading-service/Dockerfile -t $ECR_REGISTRY/togather/trading-service:${{ github.sha }} .
        docker build -f trading-service/Dockerfile -t $ECR_REGISTRY/togather/trading-service:latest .
        docker push $ECR_REGISTRY/togather/trading-service:${{ github.sha }}
        docker push $ECR_REGISTRY/togather/trading-service:latest

    - name: Build and push Pay Service image
      run: |
        docker build -f pay-service/Dockerfile -t $ECR_REGISTRY/togather/pay-service:${{ github.sha }} .
        docker build -f pay-service/Dockerfile -t $ECR_REGISTRY/togather/pay-service:latest .
        docker push $ECR_REGISTRY/togather/pay-service:${{ github.sha }}
        docker push $ECR_REGISTRY/togather/pay-service:latest

    - name: Build and push Vote Service image
      run: |
        docker build -f vote-service/Dockerfile -t $ECR_REGISTRY/togather/vote-service:${{ github.sha }} .
        docker build -f vote-service/Dockerfile -t $ECR_REGISTRY/togather/vote-service:latest .
        docker push $ECR_REGISTRY/togather/vote-service:${{ github.sha }}
        docker push $ECR_REGISTRY/togather/vote-service:latest

    - name: Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Configure kubectl for EKS
      run: |
        aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}

    - name: Install Nginx Ingress Controller
      if: github.ref == 'refs/heads/main'
      run: |
        kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/aws/deploy.yaml
        kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=300s

    - name: Deploy to EKS
      if: github.ref == 'refs/heads/main'
      run: |
        # 1. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± (ì—†ìœ¼ë©´ ìƒì„±, ìˆìœ¼ë©´ ë„˜ì–´ê°)
        kubectl apply -f k8s/namespace.yaml

        # 2. Secret ìƒì„± (ëª¨ë“  ë¯¼ê° ì •ë³´ë¥¼ GitHub Secretsì—ì„œ ê°€ì ¸ì™€ í†µí•©)
        # DB ì‚¬ìš©ì ì´ë¦„ë„ ë¯¼ê° ì •ë³´ì´ë¯€ë¡œ Secretìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ë” ì•ˆì „í•©ë‹ˆë‹¤.
        kubectl apply -f - <<EOF
        apiVersion: v1
        kind: Secret
        metadata:
          name: togather-secrets
          namespace: ${{ env.EKS_NAMESPACE }}
        type: Opaque
        stringData:
          # DB ì ‘ì† ë¹„ë°€ì •ë³´
          DB_USERNAME: "${{ secrets.DB_USERNAME }}"
          DB_PASSWORD: "${{ secrets.DB_PASSWORD }}"

          # JWT ì‹œí¬ë¦¿ í‚¤
          JWT_SECRET_KEY: "${{ secrets.JWT_SECRET_KEY }}"

          # RabbitMQ ë¹„ë°€ë²ˆí˜¸ (í•„ìš”í•˜ë‹¤ë©´ GitHub Secretìœ¼ë¡œ ê´€ë¦¬)
          RABBITMQ_PASSWORD: "${{ secrets.RABBITMQ_PASSWORD }}"
        EOF

        # 3. ë‚˜ë¨¸ì§€ ëª¨ë“  ë¦¬ì†ŒìŠ¤(ConfigMap, Deployment, Service, Ingress ë“±) ë°°í¬
        # k8s í´ë”ì˜ ëª¨ë“  .yaml íŒŒì¼ì„ togather ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì ìš©
        kubectl apply -f k8s/ -n ${{ env.EKS_NAMESPACE }}    

    - name: Wait for deployment to complete
      if: github.ref == 'refs/heads/main'
      run: |
        kubectl rollout status deployment/api-gateway -n ${{ env.EKS_NAMESPACE }} --timeout=300s
        kubectl rollout status deployment/user-service -n ${{ env.EKS_NAMESPACE }} --timeout=300s
        kubectl rollout status deployment/trading-service -n ${{ env.EKS_NAMESPACE }} --timeout=300s
        kubectl rollout status deployment/pay-service -n ${{ env.EKS_NAMESPACE }} --timeout=300s
        kubectl rollout status deployment/vote-service -n ${{ env.EKS_NAMESPACE }} --timeout=300s

    - name: Verify deployment
      if: github.ref == 'refs/heads/main'
      run: |
        kubectl get pods -n ${{ env.EKS_NAMESPACE }}
        kubectl get services -n ${{ env.EKS_NAMESPACE }}
        kubectl get ingress -n ${{ env.EKS_NAMESPACE }}